#!/bin/bash

export LC_ALL=C

export DST=$(realpath "$(dirname "$0")/..")

export HOME="$DST/var"

export PYTHONPATH="$HOME/.local/lib/python2.7"

export TMPDIR="$HOME"/tmp

export PATH="/usr/lib/ccache:/usr/local/lib/f90cache:$PATH"

export PIP_NO_BINARY=1


update() {
    pushd "$HOME"
    if test ! -d numpy; then
        git clone https://github.com/numpy/numpy.git numpy
	git -C numpy submodule init
        ln -s "$DST"/results numpy/benchmarks/results
    fi
    if test ! -f "$DST/hostname"; then
        echo "Create file called 'hostname' containing the desired host name"
        exit 1
    fi
    if test ! -f "$HOME"/.local/bin/asv; then
	ccache -M 700M || true
	f90cache -M 700M || true
    	git clone --depth 2 https://github.com/spacetelescope/asv.git "$HOME"/asv
    	pip install --user "$HOME/asv"
    	pip install --upgrade --user Cython
    fi
    git -C numpy fetch origin --tags
    git -C numpy checkout master
    git -C numpy reset --hard origin/master
    git -C numpy submodule update
    git -C numpy clean -fdx build numpy doc
    if test ! -f "$HOME/.asv-machine.json"; then
        pushd numpy/benchmarks
        while true; do echo; done | "$HOME"/.local/bin/asv machine
        popd
        M=`cat "$DST"/hostname`
        sed -i -e "s/\"machine\": .*/\"machine\": \"$M\",/" "$HOME/.asv-machine.json"
    fi
    popd
}

benchmarks() {
    update
    pushd "$HOME"/numpy/benchmarks
    sed -i -e 's/^    goal_time = 0.25/    pass#goal_time = 0.25/' benchmarks/common.py
    cp -f "$HOME"/asv.conf.json asv.conf.json
    SKIP_RUN=${SKIP_RUN=}
    if test "$SKIP_RUN" = "1"; then
        true;
    else
        ATLAS=None OPENBLAS_NUM_THREADS=1 PATH="$HOME"/.local/bin:$PATH "$HOME"/.local/bin/asv "$@"
    fi
    PATH="$HOME"/.local/bin:$PATH "$HOME"/.local/bin/asv publish
    rm -rf "$DST"/html/*
    rsync -a html/ "$DST"/html/
    popd
}

docs() {
    update
    pushd "$HOME"/numpy/doc
    rm -rf ../build ../dist build dist
    if test "$1" != ""; then
	git checkout "$1"
    fi
    git clean -fdx . ../numpy
    ATLAS=None OPENBLAS_NUM_THREADS=1 PATH=/usr/lib/ccache:"$HOME"/.local/bin:$PATH make dist
    rsync -a --delete build/dist/ "$DST"/doc/
    popd
}

# Enable strict error handling and reporting
set -e -u
set -E -o errtrace
function backtrace () {
    local deptn=${#FUNCNAME[@]}
    for ((i=1; i<$deptn; i++)); do
        local func="${FUNCNAME[$i]}"
        local line="${BASH_LINENO[$((i-1))]}"
        local src="${BASH_SOURCE[$((i-1))]}"
        printf '%*s' $i '' # indent
        echo "at: $func(), $src, line $line"
    done
}
trap 'backtrace' ERR

rm -rf "$HOME/tmp"
mkdir -p "$HOME" "$HOME/tmp"

# Run command:
if test "$1" = "benchmarks"; then
    shift
    benchmarks "$@"
elif test "$1" = "docs"; then
    shift
    docs "$@"
else
    echo "error: invalid command: $1"
    exit 1
fi
