#!/bin/bash

export LC_ALL=C

export DST=$(realpath "$(dirname "$0")/..")

export HOME="$DST/var"

export PYTHONPATH="$HOME/.local/lib/python2.7"

export TMPDIR="$HOME"/tmp

export CCACHE_UNIFY=1

export CCACHE_SLOPPINESS=file_macro,time_macros

export OPT="-O2 -g0"

export FOPT="-O2 -g0"

export PIP_NO_BINARY=1

update() {
    pushd "$HOME"
    if test ! -d scipy; then
        git clone https://github.com/scipy/scipy.git scipy
        git -C scipy submodule init
        ln -s "$DST"/results scipy/benchmarks/results
    fi
    if test ! -f "$DST/hostname"; then
        echo "Create file called 'hostname' containing the desired host name"
        exit 1
    fi
    if test ! -f "$HOME"/.local/bin/asv; then
        ccache -M 700M || true
        f90cache -M 700M || true
        git clone --depth 2 https://github.com/spacetelescope/asv.git "$HOME"/asv
        pip install --user "$HOME/asv"
        pip install --upgrade --user Cython
        mv "$HOME/.local/bin/cython" "$HOME/.local/bin/cython.real"
        cat <<__EOF__ > "$HOME/.local/bin/cython"
#!/bin/bash
$HOME/.local/bin/cython.real "$@"
EXC=$?
if test "$EXC" != "0"; then
    # Fallback for old scipy versions...
    sed -i -e 's/cpdef long int tell(self):/cpdef long int tell(self) except -1:/' streams.pyx
    sed -i -e 's/cpdef long int tell(self):/cpdef long int tell(self) except -1:/' streams.pxd
    exec $HOME/.local/bin/cython.real "$@"
fi
exit 0
__EOF__
        chmod +x "$HOME/.local/bin/cython"
    fi
    git -C scipy fetch origin
    git -C scipy checkout master
    git -C scipy branch -f maintenance/0.14.x origin/maintenance/0.14.x
    git -C scipy branch -f maintenance/0.15.x origin/maintenance/0.15.x
    git -C scipy reset --hard origin/master
    git -C scipy submodule update
    git -C scipy clean -fdx build scipy doc
    if test ! -f "$HOME/.asv-machine.json"; then
        pushd scipy/benchmarks
        while true; do echo; done | "$HOME"/.local/bin/asv machine
        popd
        M=`cat "$DST"/hostname`
        sed -i -e "s/\"machine\": .*/\"machine\": \"$M\",/" "$HOME/.asv-machine.json"
    fi
    popd
}

benchmarks() {
    update
    pushd "$HOME"/scipy/benchmarks
    sed -i -e 's/^    goal_time = 0.25/    #goal_time = 0.25\n    timeout = 120/' benchmarks/common.py
    sed -i -e 's@"branches": .*,@"branches": ["master"],@' asv.conf.json
    sed -i -e 's@x.startswith("-Werror")@x.startswith("-Werror") or x.startswith("-g")@' run.py
    SKIP_RUN=${SKIP_RUN=}
    if test "$SKIP_RUN" = "1"; then
       true
    else
       while true; do echo; done | ATLAS=None OPENBLAS_NUM_THREADS=1 PATH="$HOME"/.local/bin:$PATH python run.py "$@"
    fi
    PATH="$HOME"/.local/bin:$PATH python run.py publish
    rm -rf "$DST"/html/*
    rsync -a html/ "$DST"/html/
    popd
}

docs() {
    update
    pushd "$HOME"/scipy/doc
    rm -rf ../build ../dist build dist
    if test "$1" != ""; then
        git checkout "$1"
    fi
    git clean -fdx . ../scipy
    ATLAS=None OPENBLAS_NUM_THREADS=1 PATH=/usr/lib/ccache:"$HOME"/.local/bin:$PATH make dist
    rsync -a --delete build/dist/ "$DST"/doc/
    popd
}

# Enable strict error handling and reporting
set -e -u
set -E -o errtrace
function backtrace () {
    local deptn=${#FUNCNAME[@]}
    for ((i=1; i<$deptn; i++)); do
        local func="${FUNCNAME[$i]}"
        local line="${BASH_LINENO[$((i-1))]}"
        local src="${BASH_SOURCE[$((i-1))]}"
        printf '%*s' $i '' # indent
        echo "at: $func(), $src, line $line"
    done
}
trap 'backtrace' ERR

rm -rf "$HOME/tmp"
mkdir -p "$HOME" "$HOME/tmp"

# Run command:
if test "$1" = "benchmarks"; then
    shift
    benchmarks "$@"
elif test "$1" = "docs"; then
    shift
    docs "$@"
else
    echo "error: invalid command: $1"
    exit 1
fi
