#!/bin/bash

export LC_ALL=C

export PATH="/usr/lib/ccache:/usr/local/lib/f90cache:$PATH"

update() {
    pushd /srv/runner
    if test ! -d numpy; then
        sudo -H -u runner git clone https://github.com/numpy/numpy.git numpy
	sudo -H -u runner git -C numpy submodule init
        ln -s /srv/results numpy/benchmarks/results
    fi
    sudo -H -u runner git -C numpy fetch origin
    sudo -H -u runner git -C numpy checkout master
    sudo -H -u runner git -C numpy reset --hard origin/master
    sudo -H -u runner git -C numpy submodule update
    sudo -H -u runner git -C numpy clean -fdx build numpy doc
    popd
}

benchmarks() {
    update
    pushd /srv/runner/numpy/benchmarks
    while true; do echo; done | sudo -H -u runner ATLAS=None OPENBLAS_NUM_THREADS=1 PATH=$PATH:/srv/runner/.local/bin "$HOME"/.local/bin/asv "$@"
    sudo -H -u runner PATH=$PATH:/srv/runner/.local/bin "$HOME"/.local/bin/asv publish
    rm -rf /srv/html/*
    rsync -a html/ /srv/html/
    popd
}

docs() {
    update
    pushd /srv/runner/numpy/doc
    rm -rf ../build ../dist build dist
    if test "$1" != ""; then
	sudo -H -u runner git checkout "$1"
    fi
    sudo -H -u runner git clean -fdx . ../numpy
    sudo -H -u runner ATLAS=None OPENBLAS_NUM_THREADS=1 PATH=/usr/lib/ccache:$PATH:/srv/runner/.local/bin make dist
    rsync -a --delete build/dist/ /srv/doc/
    popd
}

# Enable strict error handling and reporting
set -e -u
set -E -o errtrace
function backtrace () {
    local deptn=${#FUNCNAME[@]}
    for ((i=1; i<$deptn; i++)); do
        local func="${FUNCNAME[$i]}"
        local line="${BASH_LINENO[$((i-1))]}"
        local src="${BASH_SOURCE[$((i-1))]}"
        printf '%*s' $i '' # indent
        echo "at: $func(), $src, line $line"
    done
}
trap 'backtrace' ERR

# Run command:
if test "$1" = "benchmarks"; then
    shift
    benchmarks "$@"
elif test "$1" = "docs"; then
    shift
    docs "$@"
else
    echo "error: invalid command: $1"
    exit 1
fi
